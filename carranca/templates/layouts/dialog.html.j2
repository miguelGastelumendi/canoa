{# ------------------------------------

layouts/dialog.html.j2
----------------------
Highly configurable template for (modal or normal) dialogs

Displays:
- /layouts/form.html.j2
- /home/document.html.j2

- names:
dlg «X» Name
X meaning:
---------------
_var_ => VARiable
_cls_ => CLaSs
dlg_name_id => ID
_blc_ => BLoCk
_bke_ => send from the back-end
_js_ => JScript
_id => ID eg dlg_submit_id

- Configuration (default is empty '', if not shown (see canoa.css))
dlg_cls_body | default('dlg-body')
dlg_close_btn_class
dlg_cls_btn_ok
dlg_cls_content
dlg_cls_dialog
dlg_cls_footer | default('dlg-footer')
dlg_cls_header | default('dlg-header')
dlg_cls_size | default('dlg-width') | modal-sm, 'Default = 500px', modal-lg, modal-xl
dlg_cls_title | default('dlg-title')
dlg_cls_top | default('mt-5')

dlg_icon_id | 'dlg-var-icon-id' // the id of the icon

dlg_var_icon_url // the url to an icon to set on the dialog header, if none, no icon is displayed
dlg_icon_size | '32px' // the icon size h=w
dlg_var_style
dlg_var_scroll
dlg_close_btn_visible | default(True) // display Close button
dlg_var_v_centered | default(False) // from is Vertical Centered

mgd
--------------------------------------- #}
{# cSpell:ignore tabindex endfor elif dlgs dlgm beforeunload #}

{% extends "./layouts/base.html.j2" %}

{% set dlg_main_id= 'dlg_main_id'%}
{% set dlg_sleep_id= 'dlg_sleep_id'%}

{% set dlg_submit_form_id= 'dlg_submit_form_id' %}
{% set dlg_submit_btn_id= 'dlg_submit_btn_i' %}
{% set dlg_btns_container_id = 'dlg_btns_container_id' %} {# <div> that contains the footer buttons #}

{% set dlg_close_form_id= 'dlg_close_form_id' %}
{% set dlg_close_x_id= 'dlg_close_x_id' %} # The upper right [x] button ID
{% set dlg_close_btn_id= 'dlg_close_btn_id' %}
{# {% set dlg_close_btn_title= dlg_close_btn_title | default('Fechar') %} #}
{% set dlg_close_btn_class= dlg_close_btn_class | default('btn-close') %} {# bootstrap class #}
{% set dlg_close_btn_visible= dlg_close_btn_visible | default(True) %}
{% set dlg_close_action_url= dlg_close_action_url | default('/login') %}

{% set dlg_icon_id= 'dlg_icon_id' %}
{% set dlg_icon_size= dlg_icon_size | default('32px') %}
{#
   SepIconConfig.content_for() is a function that determines the default
   size for icons based on application settings.
   Ensure this matches the expected dimensions for dialog icons.
#}

{% set dlg_bke_only_msg= msgOnly or False %}
{% set dlg_bke_display_ui= not dlg_bke_only_msg %}


{# ╒═════════════════════════════ Main ═════════════════════════════╕ #}
{% block base_blc_main %}
<div id="{{dlg_main_id}}" style="{{ dlg_var_style|default('display: block;') }}" class="modal {% if not (dlg_var_v_centered | default(False)) %}{{ dlg_cls_top | default('mt-5') }}{% endif -%}">

    {# ╒════════════════════════ Dialog ════════════════════════════╕ #}
    <div class="modal-dialog {{ dlg_cls_size|default('dlg-width') }}
        {%- if (dlg_var_v_centered|default(False)) %} modal-dialog-centered {% endif -%}
        {%- if dlg_var_scroll %} modal-dialog-scrollable {% endif %} {{ dlg_cls_dialog|default('') }}">

    {# ╒════════════════════════ Content ═══════════════════════════╕ #}
    <div class="modal-content{{dlg_cls_content|default('')}}">
        {# ╒════════════════════ Pillow ════════════════════════════╕ #}
        <div id="{{dlg_sleep_id}}"></div>
        {# ╘════════════════════ Pillow ════════════════════════════╛ #}

        {# ╒════════════════════ Header ════════════════════════════╕ #}
        <div class="modal-header {{dlg_cls_header | default('dlg-header')}}">
            <h5 class="modal-title {{dlg_cls_title | default('dlg-title')}}">
                {% if dlg_var_icon_url %}
                    <span class="{%- if 'sep_icons' in dlg_var_icon_url %}dlg-sep_icon-back{% else %}dlg-icon-back{% endif %}">
                        <img id="{{dlg_icon_id}}" src="{{dlg_var_icon_url}}" alt="[!]&nbsp;" height="{{dlg_icon_size}}" width="{{dlg_icon_size}}">
                    </span>
                {% endif %}
                <span inert>{{formTitle|default(app_name)}}</span>
            </h5>
            {% if dlg_close_btn_visible %}
                <button type="submit" title="Fechar" id="{{dlg_close_x_id}}" form="{{dlg_close_form_id}}" class="{{dlg_close_btn_class}}"></button>
            {% endif %}
        </div>
        {# ╘════════════════════ Header ════════════════════════════╛ #}

        {# ╒═════════════════════ Body ═════════════════════════════╕ #}
        <div class="modal-body {{ dlg_cls_body|default('dlg-body') }}">
            {# ╒═════════ Dialog Body ═════════╕ #}
            {% block dlg_blc_body %}
            {% endblock dlg_blc_body %}
            {# ╘═════════ Dialog Body ═════════╛ #}
        </div>
        {# ╘═════════════════════ Body ═════════════════════════════╛ #}

        {# ╒═════════════════════ Dialog Footer ════════════════════╕ #}
        {% block dlg_blc_footer %}
        <div class="modal-footer justify-content-center {{ dlg_cls_footer|default('dlg-footer') }}">

            {# ╒═════════ Dialog Footer Buttons═════════╕ #}
            <div id="{{dlg_btns_container_id}}" class="row">
            {% block dlg_blc_footer_buttons %}
        
            {# example <div class="col-auto">Button 1/<div> ... #}
            {% endblock dlg_blc_footer_buttons %}
            </div>
            {# ╘═════════ Dialog Footer Buttons═════════╛ #}

        </div>
        {% endblock dlg_blc_footer %}
        {# ╘═════════════════════ Dialog Footer ════════════════════╛ #}

    </div>
</div>
{% endblock base_blc_main %}


{% block base_blc_body_js %}
<script id="before_page_close">
    /** @type {CanoaGlobal} */
    window.Canoa = {
        dataModified: false,
        submitImmediately: false,
    }
    const dlgm = document.getElementById("{{ dlg_main_id }}");

    const sleep = (wait) => {
        wait = wait ?? 80;
        document.body.style.cursor = "wait";
        const dlgs = document.getElementById("{{ dlg_sleep_id }}");
        dlgs?.classList.add('dlg-sleep');
        if (wait){
            setTimeout(() => {dlgm.style.display = 'none';}, wait);
        }
    }

    window.addEventListener('beforeunload', (event) => {
        {# TODO: sessionStorage.getItem("canoa_session_started") #}
        if (Canoa.dataModified) {
            event.preventDefault();
        }
    });

    document.getElementById("{{dlg_submit_form_id}}")?.addEventListener('submit', (e) => {
        sleep((Canoa.submitImmediately? 10: 600));
    });

    document.getElementById("{{dlg_close_form_id}}")?.addEventListener('submit', (e) => {
        if (e.submitter.id == '{{dlg_close_x_id}}') {
            sleep();
        } else if (!Canoa.dataModified || confirm("Perder as alterações?")) {
            sleep();
        } else {
            e.preventDefault();
        }
    });
</script>

{# ╒═════════ Dialog JS ═════════╕ #}
{% block dlg_blc_javascript %}
{% endblock dlg_blc_javascript %}
{# ╘═════════ Dialog JS ═════════╛ #}

{% endblock base_blc_body_js %}S

{% block base_blc_forms %}
<form action="{{dlg_close_action_url}}" method="get" id="{{dlg_close_form_id}}"></form>
{# ╒═════════ Dialog Forms ═════════╕ #}
{% block dlg_blc_forms %}
{% endblock dlg_blc_forms %}
{# ╘═════════ Dialog Forms ═════════╛ #}
{% endblock base_blc_forms %}

{# eof #}